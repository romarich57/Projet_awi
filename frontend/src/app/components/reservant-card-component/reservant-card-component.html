<div class="reservant-card-page" [class.page]="isPageContext">
  @if (isPageContext) {
  <a class="back-link" routerLink="/reservants">Retour a la liste</a>
  }

  @if (reservant(); as reservantData) {
  <section class="card hero">
    <div class="hero-main">
      <p class="eyebrow">Reservant</p>
      <h1>{{ reservantData.name }}</h1>
      <div class="meta">
        <span class="badge">{{ typeLabel(reservantData.type) }}</span>
        <span class="contact">{{ displayValue(reservantData.email) }}</span>
      </div>
    </div>
    @if (isPageContext) {
    <div class="hero-actions">
      <button class="primary" [routerLink]="['/reservants', reservantData.id, 'edit']">
        Modifier les informations
      </button>
    </div>
    }
  </section>

  @if (isPageContext) {
  <section class="card workflow">
    <div class="workflow-row">
      <span class="label">Etat actuel</span>
      <span class="value">{{ workflowStateLabel(reservantData.workflow_state) }}</span>
    </div>
    <div class="workflow-row">
      <label for="workflow-state">Changer l'etat</label>
      <select id="workflow-state" [value]="reservantData.workflow_state"
        (change)="onWorkflowStateChange($any($event.target).value)">
        @for (state of workflowStates; track state.value) {
        <option [value]="state.value">{{ state.label }}</option>
        }
      </select>
    </div>
    <div class="workflow-flags">
      <p class="label">Suivi des jeux</p>
      @for (flag of workflowFlags; track flag.key) {
      <label class="flag-toggle">
        <input
          type="checkbox"
          [checked]="workflowFlagValue(reservantData, flag.key)"
          (change)="onWorkflowFlagToggle(flag.key, $any($event.target).checked)" />
        <span>{{ flag.label }}</span>
      </label>
      }
    </div>
  </section>
  }

  @if (isPageContext) {
  <section class="card contacts">
    <div class="contact-header">
      <h2>Contacts</h2>
      <p class="label">Historique des echanges</p>
    </div>
    @if (contactTimeline().length > 0) {
    <ul class="timeline">
      @for (entry of contactTimeline(); track entry.id) {
      <li>
        <div class="timeline-date">{{ entry.dateContact | date: 'shortDate' }}</div>
        <div class="timeline-body">
          <div class="timeline-title">{{ entry.contactName }}</div>
          <div class="timeline-meta">
            <span>{{ entry.contactEmail }}</span> ·
            <span>{{ entry.contactJobTitle }}</span> ·
            <span>Priorite {{ entry.contactPriority }}</span>
          </div>
        </div>
        <button class="ghost danger" type="button" (click)="deleteContactEvent(entry.id)">
          Supprimer
        </button>
      </li>
      }
    </ul>
    } @else {
    <p class="muted">Aucun contact enregistre pour le moment.</p>
    }

    <div class="contact-form">
      <h3>Creer un contact</h3>
      <div class="form-row">
        <label>Nom</label>
        <input type="text" [(ngModel)]="contactForm.name" name="contact-name" />
      </div>
      <div class="form-row">
        <label>Email</label>
        <input type="email" [(ngModel)]="contactForm.email" name="contact-email" />
      </div>
      <div class="form-row">
        <label>Telephone</label>
        <input type="text" [(ngModel)]="contactForm.phone_number" name="contact-phone" />
      </div>
      <div class="form-row">
        <label>Fonction / Type</label>
        <input type="text" [(ngModel)]="contactForm.job_title" name="contact-job" />
      </div>
      <div class="form-row">
        <label>Priorite</label>
        <input type="number" [(ngModel)]="contactForm.priority" name="contact-priority" min="1" />
      </div>
      <button class="ghost" type="button" (click)="createContact()">
        Ajouter le contact
      </button>
    </div>

    <div class="contact-form">
      <h3>Ajouter un contact</h3>
      <div class="form-row">
        <label for="contact-select">Contact</label>
        <select id="contact-select" (change)="onSelectContact($event)">
          <option value="">Selectionner un contact</option>
          @for (contact of contacts(); track contact.id) {
          <option [value]="contact.id">{{ contact.name }} (Prio {{ contact.priority }})</option>
          }
        </select>
      </div>
      <div class="form-row">
        <label for="contact-date">Date</label>
        <input id="contact-date" type="date" [value]="contactDate" (change)="onContactDateChange($event)" />
      </div>
      <button class="primary" type="button" (click)="addContactEvent()" [disabled]="!selectedContactId">
        Enregistrer le contact
      </button>
    </div>

    @if (contacts().length > 0) {
    <div class="contact-list">
      <h3>Contacts existants</h3>
      <ul>
        @for (contact of contacts(); track contact.id) {
        <li>
          {{ contact.name }} - {{ contact.email }}
          <button class="ghost danger" type="button" (click)="deleteContact(contact.id)">
            Supprimer
          </button>
        </li>
        }
      </ul>
    </div>
    }
  </section>
  }

  <section class="card info-grid">
    <div class="info">
      <span class="label">Email</span>
      <span class="value">{{ displayValue(reservantData.email) }}</span>
    </div>
    <div class="info">
      <span class="label">Telephone</span>
      <span class="value">{{ displayValue(reservantData.phone_number) }}</span>
    </div>
    <div class="info">
      <span class="label">Adresse</span>
      <span class="value">{{ displayValue(reservantData.address) }}</span>
    </div>
    <div class="info">
      <span class="label">Siret</span>
      <span class="value">{{ displayValue(reservantData.siret) }}</span>
    </div>
    <div class="info full">
      <span class="label">Notes</span>
      <span class="value">{{ displayValue(reservantData.notes) }}</span>
    </div>
  </section>
  } @else {
  <section class="card empty">
    <p>Reservant introuvable ou en cours de chargement.</p>
  </section>
  }
</div>
