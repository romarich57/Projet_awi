<section class="dashboard">
  <a class="back-link" routerLink="/festivals">← Retour à la liste des festivals</a>

  <header class="dashboard-header">
    <p class="eyebrow">Dashboard</p>
    <h1>Dashboard des Réservations</h1>
  </header>

  @if (festivalState.currentFestival()) {
    <section class="festival-summary card">
      <div class="summary-main">
        <div>
          <p class="label">Festival</p>
          <h2>{{ festivalState.currentFestival()?.name }}</h2>
        </div>
        @if (!showReservationForm()) {
          <button class="primary" (click)="openReservationForm()">Nouvelle Réservation</button>
        }
      </div>
      <div class="summary-stats">
        <div class="stat">
          <span>Tables standard</span>
          <strong>{{ festivalState.currentFestival()?.stock_tables_standard }}</strong>
        </div>
        <div class="stat">
          <span>Tables grandes</span>
          <strong>{{ festivalState.currentFestival()?.stock_tables_grande }}</strong>
        </div>
        <div class="stat">
          <span>Tables mairie</span>
          <strong>{{ festivalState.currentFestival()?.stock_tables_mairie }}</strong>
        </div>
        <div class="stat">
          <span>Chaises</span>
          <strong>{{ festivalState.currentFestival()?.stock_chaises }}</strong>
        </div>
      </div>
    </section>

    @if (showReservationForm()) {
      <section class="form-panel card">
        <app-reservation-form-component
          [festivalName]="festivalState.currentFestival()?.name"
          [festivalId]="festivalState.currentFestival()?.id"
          (closeForm)="showReservationForm.set(false)"
          (reservationCreated)="onReservationCreated()"></app-reservation-form-component>
      </section>
    }



    <section class="filters card">

      <label class="field">
        <span>Nom du réservant: </span>
        <div class="search-box">  
          <input 
            type="text" 
            placeholder="Rechercher un réservant..." 
            (input)="setSearchQuery($any($event.target).value)"
            class="search-input"
          >
        </div>
      </label>

      <label class="field">
        <span>Type</span>
        <select [value]="typeFilter()" (change)="setTypeFilter($any($event.target).value)">
          <option value="all">Tous les types</option>
          <option value="editeur">Editeur</option>
          <option value="prestataire">Prestataire</option>
          <option value="boutique">Boutique</option>
          <option value="animateur">Animateur</option>
          <option value="association">Association</option>
        </select>
      </label>

      <label class="field">
        <span>Trier par</span>
        <select [value]="sortKey()" (change)="setSortKey($any($event.target).value)">
          <option value="name-asc">Nom (A -> Z)</option>
          <option value="name-desc">Nom (Z -> A)</option>
        </select>
      </label>
    </section>


    <section class="reservation-table card">
      @if (loading()) {
        <p class="muted">Chargement...</p>
      }
      @if (loadError()) {
        <p class="error">{{ loadError() }}</p>
      }
      @if (deleteError()) {
        <p class="error">{{ deleteError() }}</p>
      }

      @if (reservationsView().length > 0) {
        <div class="table-head">
          <span>Reservant</span>
          <span>Type</span>
          <span>Statut de la Réservation</span>
          <span>Actions</span>
        </div>

        @for(reservation of reservationsView(); track reservation.id) {
          <div class="table-row">
            <div class="cell" data-label="Reservant">{{ reservation.reservant_name }}</div>
            <div class="cell" data-label="Type">{{ reservation.reservant_type }}</div>
            <div class="cell" data-label="Statut">
              <span class="status-pill">{{ reservation.workflow_state }}</span>
            </div>
            <div class="cell actions" data-label="Actions">
              <button class="action-btn" (click)="viewReservationDetails(reservation.id)">Voir Détails</button>
              @if (canDeleteReservation()) {
                <button class="action-btn danger" (click)="requestDelete(reservation)">Supprimer</button>
              }
            </div>
          </div>
        }
      } @else if (!loading()) {
        <p class="empty-state">Aucune réservation trouvée pour ce festival.</p>
      }
    </section>

    @if (pendingDelete()) {
      <div class="modal-backdrop" (click)="cancelDelete()"></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="delete-title">
        <h3 id="delete-title">Confirmation</h3>
        <p class="muted">{{ deletePrompt() }}</p>
        <p class="warning">
          Cette suppression entrainera la suppression des donnees liees a la reservation.
        </p>

        @if (deleteSummaryLoading()) {
          <p class="muted">Chargement des dependances...</p>
        }

        @if (deleteSummaryError()) {
          <p class="error">{{ deleteSummaryError() }}</p>
        }
        @if (deleteError()) {
          <p class="error">{{ deleteError() }}</p>
        }

        @if (deleteSummaryForPending(); as summary) {
          <div class="delete-summary">
            <div class="summary-section">
              <h4>Zones tarifaires ({{ summary.zones_tarifaires.length }})</h4>
              @if (summary.zones_tarifaires.length === 0) {
                <p class="muted">Aucune zone tarifaire associee.</p>
              } @else {
                <div class="summary-list">
                  @for (zone of summary.zones_tarifaires; track zone.zone_tarifaire_id) {
                    <p>{{ zone.zone_name }} · {{ zone.nb_tables_reservees }} tables</p>
                  }
                </div>
              }
            </div>

            <div class="summary-section">
              <h4>Zones plan ({{ summary.zone_plan_allocations.length }})</h4>
              @if (summary.zone_plan_allocations.length === 0) {
                <p class="muted">Aucune zone plan associee.</p>
              } @else {
                <div class="summary-list">
                  @for (zone of summary.zone_plan_allocations; track zone.zone_plan_id) {
                    <p>{{ zone.zone_plan_name }} · {{ zone.nb_tables }} tables</p>
                  }
                </div>
              }
            </div>

            <div class="summary-section">
              <h4>Jeux alloues ({{ summary.games_allocations.length }})</h4>
              @if (summary.games_allocations.length === 0) {
                <p class="muted">Aucun jeu alloue.</p>
              } @else {
                <div class="summary-list">
                  @for (game of summary.games_allocations; track game.id) {
                    <p>{{ game.game_title }} · {{ game.nb_tables_occupees }} tables</p>
                  }
                </div>
              }
            </div>
          </div>
        }

        <div class="modal-actions">
          <button type="button" class="ghost" (click)="cancelDelete()">Annuler</button>
          <button type="button" class="danger" (click)="confirmDelete()" [disabled]="isDeleting()">
            Supprimer
          </button>
        </div>
      </div>
    }
  }
  @else {
    <div class="no-festival card">
      <p>Veuillez sélectionner un festival depuis la page d'accueil pour voir les réservations.</p>
    </div>
  }
</section>
