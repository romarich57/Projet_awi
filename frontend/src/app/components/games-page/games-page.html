<section class="games-header card">
  <div class="header-main">
    <div>
      <p class="eyebrow">Catalogue maître</p>
      <h1>Jeux</h1>
      <p class="muted">Filtrer, créer ou modifier les jeux du catalogue.</p>
    </div>
    <button type="button" class="primary" (click)="startCreate()">
      + Nouveau jeu
    </button>
  </div>

  <form class="filters" (ngSubmit)="loadGames()">
    <label>
      <span>Titre</span>
      <input
        type="text"
        name="title-filter"
        placeholder="Rechercher un titre"
        [(ngModel)]="filters.title"
        (ngModelChange)="loadGames()" />
    </label>
    <label>
      <span>Type</span>
      <select name="type-filter" [(ngModel)]="filters.type" (change)="loadGames()">
        <option value="">Tous</option>
        @for (type of types(); track type) {
          <option [value]="type">{{ type }}</option>
        }
      </select>
    </label>
    <label>
      <span>Éditeur</span>
      <select name="editor-filter" [(ngModel)]="filters.editorId" (change)="loadGames()">
        <option value="">Tous</option>
        @for (editor of editors(); track editor.id) {
          <option [value]="editor.id">{{ editor.name }}</option>
        }
      </select>
    </label>
    <label>
      <span>Âge min.</span>
      <input
        type="number"
        min="0"
        name="age-filter"
        [(ngModel)]="filters.minAge"
        (ngModelChange)="loadGames()" />
    </label>
  </form>

  <div class="column-toggles">
    <span>Colonnes visibles :</span>
    @for (opt of columnOptions; track opt.key) {
      <label>
        <input
          type="checkbox"
          [checked]="visibleColumns[opt.key]"
          (change)="visibleColumns[opt.key] = $any($event.target).checked" />
        <span>{{ opt.label }}</span>
      </label>
    }
  </div>
</section>

<section class="games-table card">
  @if (loading()) {
    <p class="muted">Chargement...</p>
  }
  @if (error()) {
    <p class="error">{{ error() }}</p>
  }
  @if (deleteError()) {
    <p class="error">{{ deleteError() }}</p>
  }

  @if (games().length === 0 && !loading()) {
    <p class="muted">Aucun jeu trouvé avec ces filtres.</p>
  } @else {
    <div class="table-head">
      <div class="head-title">Titre</div>
      @if (visibleColumns['type']) { <div>Type</div> }
      @if (visibleColumns['editor']) { <div>Éditeur</div> }
      @if (visibleColumns['age']) { <div>Âge</div> }
      @if (visibleColumns['players']) { <div>Joueurs</div> }
      @if (visibleColumns['authors']) { <div>Auteurs</div> }
      @if (visibleColumns['mechanisms']) { <div>Mécanismes</div> }
      @if (visibleColumns['theme']) { <div>Thème</div> }
      @if (visibleColumns['duration']) { <div>Durée</div> }
      @if (visibleColumns['prototype']) { <div>Proto</div> }
      @if (visibleColumns['description']) { <div>Description</div> }
      <div class="head-actions">Actions</div>
    </div>

    <div class="game-list">
      @for (game of games(); track game.id) {
        <div class="game-row">
          <div class="row-main">
            <div class="game-avatar" [class.fallback]="!game.image_url">
              @if (game.image_url) {
                <img [src]="game.image_url" [alt]="game.title" loading="lazy" />
              } @else {
                <span>{{ game.title.charAt(0) || '?' }}</span>
              }
            </div>
            <div class="title-block">
              <div class="title highlight">{{ game.title }}</div>
              <div class="subline">
                @if (visibleColumns['type']) { <span class="pill">{{ game.type }}</span> }
                @if (visibleColumns['editor']) { <span class="pill">{{ game.editor_name || '—' }}</span> }
                @if (visibleColumns['age']) { <span class="pill">{{ ageLabel(game) }}</span> }
                @if (visibleColumns['players']) { <span class="pill">{{ playersLabel(game) }}</span> }
                @if (visibleColumns['prototype'] && game.prototype) { <span class="pill warn">Prototype</span> }
              </div>
            </div>
          </div>

          <div class="row-meta">
            @if (visibleColumns['authors']) {
              <div class="meta-item">
                <span class="label">Auteurs</span>
                <span class="value">{{ game.authors }}</span>
              </div>
            }
            @if (visibleColumns['mechanisms']) {
              <div class="meta-item mechanisms">
                <span class="label">Mécanismes</span>
                <div class="chips">
                  @if (game.mechanisms?.length) {
                    @for (m of game.mechanisms!; track m.id) {
                      <span class="chip">{{ m.name }}</span>
                    }
                  } @else {
                    <span class="muted">—</span>
                  }
                </div>
              </div>
            }
            @if (visibleColumns['theme']) {
              <div class="meta-item">
                <span class="label">Thème</span>
                <span class="value">{{ game.theme || '—' }}</span>
              </div>
            }
            @if (visibleColumns['duration']) {
              <div class="meta-item">
                <span class="label">Durée</span>
                <span class="value">{{ durationLabel(game) }}</span>
              </div>
            }
            @if (visibleColumns['description'] && descriptionSnippet(game)) {
              <div class="meta-item description">
                <span class="label">Description</span>
                <span class="value">{{ descriptionSnippet(game) }}</span>
              </div>
            }
          </div>

          <div class="row-actions">
            <a class="primary strong" [routerLink]="['/games', game.id, 'edit']">Modifier</a>
            <button type="button" class="ghost danger strong" (click)="deleteGame(game)">Supprimer</button>
          </div>
        </div>
      }
    </div>
  }
</section>
