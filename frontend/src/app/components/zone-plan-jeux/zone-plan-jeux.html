<div class="zone-plan-jeux-container">
    @if (festivalId()) {
        <!-- Section des jeux non allou√©s -->
        <div class="jeux-non-alloues">
            <h4>üéÆ Jeux non allou√©s ({{ jeuxNonAlloues().length }})</h4>
            @if (jeuxNonAlloues().length > 0) {
                <div class="jeux-list compact">
                    @for (jeu of jeuxNonAlloues(); track jeu.allocation_id) {
                        <div class="jeu-item non-alloue">
                            <div class="jeu-info">
                                <span class="jeu-title">{{ jeu.title }}</span>
                                <span class="jeu-reservant">{{ jeu.reservant_name }}</span>
                                <span class="jeu-tables">{{ jeu.nb_tables_occupees }} table(s)</span>
                            </div>
                        </div>
                    }
                </div>
            } @else {
                <p class="empty-message">‚úÖ Tous les jeux sont allou√©s √† une zone.</p>
            }
        </div>

        <hr class="section-divider">

        <!-- Liste des zones de plan -->
        <div class="zones-list">
            <h4>üìç Zones de plan</h4>
            @for (zone of zonesAvecJeux(); track zone.id) {
                <div class="zone-card" [class.expanded]="zone.expanded">
                    <div class="zone-header" (click)="toggleZoneExpansion(zone.id)">
                        <div class="zone-info">
                            <span class="zone-name">{{ zone.name }}</span>
                            <span class="zone-tarifaire">{{ zone.zone_tarifaire_name }}</span>
                        </div>
                        <div class="zone-stats">
                            <span class="tables-count">
                                üìä {{ tablesUtiliseesParZone()[zone.id] || 0 }} / {{ zone.nb_tables }} tables
                            </span>
                            <span class="tables-restantes" [class.warning]="tablesRestantesParZone()[zone.id] <= 2" [class.danger]="tablesRestantesParZone()[zone.id] <= 0">
                                ({{ tablesRestantesParZone()[zone.id] }} restantes)
                            </span>
                            @if ((tablesSimplesParZone()[zone.id] || 0) > 0) {
                                <span class="simple-count">Plan simple : {{ tablesSimplesParZone()[zone.id] }} table(s)</span>
                            }
                            <span class="jeux-count">üé≤ {{ zone.jeuxAlloues.length }} jeux</span>
                        </div>
                        <div class="zone-actions">
                            <button class="btn-allocate" (click)="openAllocationModal(zone); $event.stopPropagation();" [disabled]="tablesRestantesParZone()[zone.id] <= 0">
                                ‚ûï Ajouter un jeu
                            </button>
                            <button class="btn-edit" (click)="openEditForm(zone); $event.stopPropagation();">‚úèÔ∏è</button>
                            <button class="btn-delete" (click)="deleteZonePlan(zone.id); $event.stopPropagation();" [disabled]="zone.jeuxAlloues.length > 0">üóëÔ∏è</button>
                            <span class="expand-icon">{{ zone.expanded ? '‚ñº' : '‚ñ∂' }}</span>
                        </div>
                    </div>
                    
                    @if (zone.expanded) {
                        <div class="zone-content">
                            @if (zone.jeuxAlloues.length > 0) {
                                <table class="jeux-table">
                                    <thead>
                                        <tr>
                                            <th>Jeu</th>
                                            <th>R√©servant</th>
                                            <th>Tables occup√©es</th>
                                            <th>Exemplaires</th>
                                            <th>Taille table</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (jeu of zone.jeuxAlloues; track jeu.allocation_id) {
                                            <tr>
                                                <td class="jeu-title">{{ jeu.title }}</td>
                                                <td>{{ jeu.reservant_name }}</td>
                                                <td>
                                                    <div class="nb-tables-control">
                                                        <button class="btn-small" (click)="updateNbTables(jeu, jeu.nb_tables_occupees - 0.5)" [disabled]="jeu.nb_tables_occupees <= 0.5">-</button>
                                                        <span>{{ jeu.nb_tables_occupees }}</span>
                                                        <button class="btn-small" (click)="updateNbTables(jeu, jeu.nb_tables_occupees + 0.5)">+</button>
                                                    </div>
                                                </td>
                                                <td>{{ jeu.nb_exemplaires }}</td>
                                                <td>{{ jeu.taille_table_requise }}</td>
                                                <td>
                                                    <button class="btn-remove" (click)="removeGameFromZone(jeu)">Retirer</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            } @else {
                                <p class="empty-zone">Aucun jeu allou√© √† cette zone.</p>
                            }
                        </div>
                    }
                </div>
            } @empty {
                <p class="empty-zone">Aucune zone associ√©e √† ce festival.</p>
            }
        </div>

        <button class="add-zone-button" (click)="openForm()">‚ûï Ajouter une zone</button>

        <!-- Modal de cr√©ation/√©dition de zone -->
        @if (showForm()) {
            <app-zone-plan-form
                [festivalId]="festivalId()!"
                [zoneTarifaires]="zoneTarifaires()"
                [tablesRestantes]="tablesRestantesParZoneTarifaire()"
                [zonePlanToEdit]="zonePlanToEdit()"
                (formClosed)="closeForm()"
                (zonePlanCreated)="onZonePlanCreated()">
            </app-zone-plan-form>
        }

        <!-- Modal d'allocation de jeu -->
        @if (showAllocationModal()) {
            <div class="modal-overlay" (click)="closeAllocationModal()">
                <div class="modal-content" (click)="$event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Allouer un jeu √† : {{ selectedZone()?.name }}</h3>
                        <button class="btn-close" (click)="closeAllocationModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <p>Tables disponibles : <strong>{{ tablesRestantesParZone()[selectedZone()!.id] }}</strong></p>
                        
                        <!-- Affichage du stock par type de table -->
                        @if (stockTables().length > 0) {
                            <div class="stock-tables-info">
                                <h5>üì¶ Stock global de tables par type :</h5>
                                <div class="stock-grid">
                                    @for (stock of stockTables(); track stock.table_type) {
                                        <div class="stock-item" [class.epuise]="stock.restantes <= 0" [class.faible]="stock.restantes > 0 && stock.restantes <= 2">
                                            <span class="stock-type">{{ stock.table_type }}</span>
                                            <span class="stock-count">{{ stock.restantes }} / {{ stock.total }}</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        
                        @if (jeuxDisponiblesPourZone().length > 0) {
                            <h4>S√©lectionner un jeu :</h4>
                            <div class="jeux-selection">
                                @for (jeu of jeuxDisponiblesPourZone(); track jeu.allocation_id) {
                                    <div class="jeu-option" 
                                         [class.selected]="selectedGame()?.allocation_id === jeu.allocation_id"
                                         (click)="selectGameForAllocation(jeu)">
                                        <span class="jeu-title">{{ jeu.title }}</span>
                                        <span class="jeu-reservant">{{ jeu.reservant_name }}</span>
                                        <span class="jeu-tables">{{ jeu.nb_tables_occupees }} table(s)</span>
                                    </div>
                                }
                            </div>

                            @if (selectedGame()) {
                                <div class="allocation-options">
                                    <label>
                                        Place occup√©e par exemplaire :
                                        <input type="number" 
                                               [ngModel]="placeOccupeeInput()" 
                                               (ngModelChange)="placeOccupeeInput.set($event)"
                                               min="0.5" 
                                               step="0.5">
                                        <small class="hint-text">Ex: 0.5 = demi-table, 1 = table enti√®re, 2 = deux tables</small>
                                    </label>
                                    
                                    <label>
                                        Nombre d'exemplaires :
                                        <input type="number" 
                                               [ngModel]="nbExemplairesInput()" 
                                               (ngModelChange)="nbExemplairesInput.set($event)"
                                               min="1" 
                                               step="1">
                                    </label>
                                    
                                    <label>
                                        Type de table :
                                        <select [ngModel]="tailleTableInput()" (ngModelChange)="tailleTableInput.set($event)">
                                            @for (stock of stockTables(); track stock.table_type) {
                                                <option [value]="stock.table_type" [disabled]="stock.restantes < tablesCalculees()">
                                                    {{ stock.table_type }} - {{ stock.restantes }} dispo
                                                </option>
                                            }
                                            @if (stockTables().length === 0) {
                                                <option value="standard">Standard</option>
                                                <option value="grande">Grande</option>
                                                <option value="mairie">Mairie</option>
                                            }
                                        </select>
                                    </label>
                                    
                                    <p class="tables-calculees">
                                        üìä Tables occup√©es : <strong>{{ tablesCalculees() }}</strong> 
                                        ({{ placeOccupeeInput() }} √ó {{ nbExemplairesInput() }} exemplaire(s))
                                    </p>
                                    
                                    <p class="hint" [class.warning]="tablesCalculees() > tablesRestantesParZone()[selectedZone()!.id]">
                                        üí° Tables disponibles dans cette zone : {{ tablesRestantesParZone()[selectedZone()!.id] }}
                                    </p>
                                    
                                    @if (stockInsuffisant()) {
                                        <p class="error">‚ö†Ô∏è Stock insuffisant pour ce type de table ({{ stockPourTailleSelectionnee() }} restantes)</p>
                                    }
                                </div>
                            }
                        } @else {
                            <p class="empty-message warning-message">
                                ‚ö†Ô∏è Aucun jeu disponible pour cette zone.<br>
                                <small>Les jeux doivent appartenir √† un r√©servant qui a r√©serv√© des tables dans la zone tarifaire "{{ selectedZone()?.zone_tarifaire_name }}".</small>
                            </p>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" (click)="closeAllocationModal()">Annuler</button>
                        <button class="btn-confirm" 
                                (click)="allocateGame()" 
                                [disabled]="!selectedGame() || loading() || tablesCalculees() > tablesRestantesParZone()[selectedZone()!.id] || stockInsuffisant()">
                            {{ loading() ? 'Allocation...' : 'Allouer le jeu' }}
                        </button>
                    </div>
                </div>
            </div>
        }
    }
</div>
