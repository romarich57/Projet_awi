<div class="zone-plan-jeux-container">
    <!-- Bloc conditionnel principal -->
    @if (festivalId()) {
        @if (isGameMode()) {
            <!-- Section des jeux non allou√©s -->
            <div class="jeux-non-alloues">
                <h4>üéÆ Jeux non allou√©s ({{ jeuxNonAlloues().length }})</h4>
                @if (jeuxNonAlloues().length > 0) {
                    <div class="jeux-list compact">
                        @for (jeu of jeuxNonAlloues(); track jeu.allocation_id) {
                            <div class="jeu-item non-alloue">
                                <div class="jeu-info">
                                    <span class="jeu-title">{{ jeu.title }}</span>
                                    <span class="jeu-reservant">{{ jeu.reservant_name }}</span>
                                </div>
                            </div>
                        }
                    </div>
                } @else {
                    <p class="empty-message">‚úÖ Tous les jeux sont allou√©s √† une zone.</p>
                }
            </div>

            <hr class="section-divider">
        }

        
        <div class="chaises-stock-global">
            <span class="chaises-label">ü™ë Stock chaises festival :</span>
            <span class="chaises-count" [class.low-stock]="chaisesStock().available <= 10">
                {{ chaisesStock().available }} disponibles / {{ chaisesStock().total }} total
            </span>
        </div>
        

        <!-- Liste des zones de plan -->
        <div class="zones-list">
            <h4>üìç Zones de plan</h4>
            @for (zone of zonesAvecJeux(); track zone.id) {
                <div class="zone-card" [class.expanded]="zone.expanded">
                    <div class="zone-header" (click)="toggleZoneExpansion(zone.id)">
                        <div class="zone-info">
                            <span class="zone-name">{{ zone.name }}</span>
                            <span class="zone-tarifaire">{{ zone.zone_tarifaire_name }}</span>
                        </div>
                        <div class="zone-stats">
                            <span class="tables-count">
                                üìä {{ tablesUtiliseesParZone()[zone.id] || 0 }} / {{ zone.nb_tables }} tables
                            </span>
                            <span class="tables-restantes"
                                  [class.warning]="isGameMode() ? tablesRestantesParZone()[zone.id] <= 2 : tablesDisponiblesPourZone(zone) <= 2"
                                  [class.danger]="isGameMode() ? tablesRestantesParZone()[zone.id] <= 0 : tablesDisponiblesPourZone(zone) <= 0">
                                @if (isGameMode()) {
                                    ({{ tablesRestantesParZone()[zone.id] }} restantes)
                                } @else {
                                    ({{ tablesDisponiblesPourZone(zone) }} dispo pour ce r√©servant)
                                }
                            </span>
                            @if ((tablesSimplesParZone()[zone.id] || 0) > 0) {
                                <span class="simple-count">Plan simple : {{ tablesSimplesParZone()[zone.id] }} table(s)</span>
                            }

                            <span class="jeux-count">üé≤ {{ zone.jeuxAlloues.length }} jeux</span>
                        </div>
                        <div class="zone-actions">
                            <button class="btn-allocate"
                                    (click)="openAllocationModal(zone); $event.stopPropagation();"
                                    [disabled]="isGameMode() ? tablesRestantesParZone()[zone.id] <= 0 : !isZoneEligible(zone)">
                                {{ isGameMode() ? '‚ûï Ajouter un jeu' : '‚ûï Affecter' }}
                            </button>
                            <button class="btn-edit" (click)="openEditForm(zone); $event.stopPropagation();">‚úèÔ∏è</button>
                            <button class="btn-delete"
                                    (click)="deleteZonePlan(zone.id); $event.stopPropagation();"
                                    [disabled]="zone.jeuxAlloues.length > 0 || (tablesSimplesParZone()[zone.id] || 0) > 0 || (chaisesAlloueesParZone()[zone.id] || 0) > 0">üóëÔ∏è</button>
                            <span class="expand-icon">{{ zone.expanded ? '‚ñº' : '‚ñ∂' }}</span>
                        </div>
                    </div>
                    
                    @if (zone.expanded) {
                        <div class="zone-content">
                            @if (!isGameMode() && !isZoneEligible(zone)) {
                                <p class="empty-zone warning-message">
                                    ‚ö†Ô∏è Cette zone est li√©e √† une zone tarifaire non r√©serv√©e par ce r√©servant.
                                </p>
                            }

                            @if (zone.jeuxAlloues.length > 0 || zone.simpleAllocations.length > 0) {
                                <table class="jeux-table">
                                    <thead>
                                        <tr>
                                            <th>Jeu</th>
                                            <th>R√©servant</th>
                                            <th>Tables occup√©es</th>
                                            <th>Exemplaires</th>
                                            <th>Taille table</th>
                                            <th>Chaises</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (jeu of zone.jeuxAlloues; track jeu.allocation_id) {
                                            <tr>
                                                <td class="jeu-title">{{ jeu.title }}</td>
                                                <td>{{ jeu.reservant_name }}</td>
                                                <td>
                                                    <div class="nb-tables-control">
                                                        <span>{{ jeu.nb_tables_occupees }}</span>
                                                    </div>
                                                </td>
                                                <td>{{ jeu.nb_exemplaires }}</td>
                                                <td>{{ jeu.taille_table_requise }}</td>
                                                <td>{{ jeu.nb_chaises || 0 }}</td> 
                                                <td>                                               
                                                    @if (jeu.reservation_id === reservation()?.id) {
                                                        <button class="btn-remove" (click)="removeGameFromZone(jeu)">Retirer</button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @for (allocation of zone.simpleAllocations; track allocation.reservation_id) {
                                            <tr>
                                                <td class="jeu-title">Aucun</td>
                                                <td>{{ allocation.reservant_name }}</td>
                                                <td>{{ allocation.nb_tables }}</td>
                                                <td>0</td>
                                                <td>Aucun</td>
                                                <td>{{ allocation.nb_chaises }}</td>
                                                <td>
                                                    @if (allocation.reservation_id === reservation()?.id) {
                                                        <button class="btn-remove" (click)="removeSimpleAllocation(zone.id)">Retirer</button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            } @else {
                                <p class="empty-zone">Aucune allocation dans cette zone.</p>
                            }
                        </div>
                    }
                </div>
            } @empty {
                <p class="empty-zone">Aucune zone associ√©e √† ce festival.</p>
            }
        </div>

        <button class="add-zone-button" (click)="openForm()">‚ûï Ajouter une zone</button>

        <!-- Modal de cr√©ation/√©dition de zone -->
        @if (showForm()) {
            <app-zone-plan-form
                [festivalId]="festivalId()!"
                [zoneTarifaires]="zoneTarifaires()"
                [tablesRestantes]="tablesRestantesParZoneTarifaire()"
                [zonePlanToEdit]="zonePlanToEdit()"
                (formClosed)="closeForm()"
                (zonePlanCreated)="onZonePlanCreated()">
            </app-zone-plan-form>
        }

        <!-- Modal d'allocation de jeu -->
        @if (showAllocationModal()) {
            <div class="modal-overlay" (click)="closeAllocationModal()">
                <div class="modal-content" (click)="$event.stopPropagation()">
                    <div class="modal-header">
                        <h3>{{ isGameMode() ? 'Allouer un jeu √† : ' : 'Affecter des tables √† : ' }}{{ selectedZone()?.name }}</h3>
                        <button class="btn-close" (click)="closeAllocationModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        @if (isGameMode()) {
                            <p>Tables disponibles : <strong>{{ tablesRestantesParZone()[selectedZone()!.id] }}</strong></p>
                            
                            <!-- Affichage du stock par type de table -->
                            @if (stockTables().length > 0) {
                                <div class="stock-tables-info">
                                    <h5>üì¶ Stock global de tables par type :</h5>
                                    <div class="stock-grid">
                                        @for (stock of stockTables(); track stock.table_type) {
                                            <div class="stock-item" [class.epuise]="stock.restantes <= 0" [class.faible]="stock.restantes > 0 && stock.restantes <= 2">
                                                <span class="stock-type">{{ stock.table_type }}</span>
                                                <span class="stock-count">{{ stock.restantes }} / {{ stock.total }}</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            @if (jeuxDisponiblesPourZone().length > 0) {
                                <h4>S√©lectionner un jeu :</h4>
                                <div class="jeux-selection">
                                    @for (jeu of jeuxDisponiblesPourZone(); track jeu.allocation_id) {
                                        <div class="jeu-option" 
                                             [class.selected]="selectedGame()?.allocation_id === jeu.allocation_id"
                                             (click)="selectGameForAllocation(jeu)">
                                            <span class="jeu-title">{{ jeu.title }}</span>
                                            <span class="jeu-reservant">{{ jeu.reservant_name }}</span>
                                            <span class="jeu-tables">{{ jeu.nb_tables_occupees }} table(s)</span>
                                        </div>
                                    }
                                </div>

                                @if (selectedGame()) {
                                    <div class="allocation-options">
                                        <div class="input-toggle">
                                            <button
                                                type="button"
                                                class="toggle-btn"
                                                [class.active]="gameInputMode() === 'tables'"
                                                (click)="setGameInputMode('tables')">
                                                Tables
                                            </button>
                                            <button
                                                type="button"
                                                class="toggle-btn"
                                                [class.active]="gameInputMode() === 'm2'"
                                                (click)="setGameInputMode('m2')">
                                                m¬≤
                                            </button>
                                        </div>

                                        @if (gameInputMode() === 'tables') {
                                            <label>
                                                Place occup√©e (tables par exemplaire) :
                                                <input type="number" 
                                                       [ngModel]="gameTablesInput()" 
                                                       (ngModelChange)="onGameTablesInputChange($event)"
                                                       min="0" 
                                                       step="0.5">
                                            </label>
                                        } @else {
                                            <label>
                                                m¬≤ :
                                                <input type="number" 
                                                       [ngModel]="gameM2Input()" 
                                                       (ngModelChange)="onGameM2InputChange($event)"
                                                       min="0" 
                                                       step="0.5">
                                                <small class="hint-text">= {{ gameTablesInput() }} table(s)</small>
                                            </label>
                                        }
                                        
                                        <label>
                                            Nombre d'exemplaires :
                                            <input type="number" 
                                                   [ngModel]="nbExemplairesInput()" 
                                                   (ngModelChange)="onNbExemplairesChange($event)"
                                                   min="1" 
                                                   step="1">
                                        </label>
                                        
                                        <label>
                                            Type de table :
                                            <select [ngModel]="tailleTableInput()" (ngModelChange)="tailleTableInput.set($event)">
                                                <option value="aucun">Aucun (chaises uniquement)</option>
                                                @for (stock of stockTables(); track stock.table_type) {
                                                    <option [value]="stock.table_type" [disabled]="stock.restantes < tablesCalculees()">
                                                        {{ stock.table_type }} - {{ stock.restantes }} dispo
                                                    </option>
                                                }
                                                @if (stockTables().length === 0) {
                                                    <option value="standard">Standard</option>
                                                    <option value="grande">Grande</option>
                                                    <option value="mairie">Mairie</option>
                                                }
                                            </select>
                                        </label>

                                        <!-- Section Chaises -->
                                        <div class="chaises-section">
                                            <label>
                                                Chaises :
                                                <input type="number" 
                                                       [ngModel]="chaisesInput()" 
                                                       (ngModelChange)="onChaisesInputChange($event)"
                                                       min="0" 
                                                       step="1"
                                                       max="{{ chaisesDisponibles() }}">
                                            </label>
                                            <small class="hint-text">
                                                Disponibles : {{ chaisesDisponibles() }} / {{ chaisesStock().total }}
                                            </small>
                                        </div>
                                        
                                        <p class="tables-calculees">
                                            üìä Tables occup√©es : <strong>{{ tablesCalculees() }}</strong>
                                            ({{ nbExemplairesInput() }} exemplaire(s))
                                        </p>
                                        
                                        <p class="hint" [class.warning]="tablesCalculees() > tablesRestantesParZone()[selectedZone()!.id]">
                                            üí° Tables disponibles dans cette zone : {{ tablesRestantesParZone()[selectedZone()!.id] }}
                                        </p>
                                        
                                        <p class="hint" [class.warning]="selectedZone() && tablesCalculees() > quotaRestantPourZone(selectedZone()!)">
                                            Tables restantes dans la r√©servation ({{ selectedZone()?.zone_tarifaire_name }}) : 
                                            <strong>{{ selectedZone() ? quotaRestantPourZone(selectedZone()!) : 0 }}</strong>
                                        </p>
                                        @if (stockInsuffisant()) {
                                            <p class="error">‚ö†Ô∏è Stock insuffisant pour ce type de table ({{ stockPourTailleSelectionnee() }} restantes)</p>
                                        }
                                    </div>
                                }
                            } @else {
                                <p class="empty-message warning-message">
                                    ‚ö†Ô∏è Aucun jeu disponible pour cette zone.<br>
                                    <small>Les jeux doivent appartenir √† un r√©servant qui a r√©serv√© des tables dans la zone tarifaire "{{ selectedZone()?.zone_tarifaire_name }}".</small>
                                </p>
                            }
                        } @else {
                            <p>Tables r√©serv√©es dans la zone tarifaire :
                                <strong>{{ tablesReserveesParZoneTarifaire()[selectedZone()!.id_zone_tarifaire] || 0 }}</strong>
                            </p>
                            <p>Tables disponibles pour ce r√©servant :
                                <strong>{{ tablesDisponiblesPourZone(selectedZone()!) }}</strong>
                            </p>

                            <div class="allocation-options">
                                <div class="input-toggle">
                                    <button
                                        type="button"
                                        class="toggle-btn"
                                        [class.active]="simpleInputMode() === 'tables'"
                                        (click)="setSimpleInputMode('tables')">
                                        Tables
                                    </button>
                                    <button
                                        type="button"
                                        class="toggle-btn"
                                        [class.active]="simpleInputMode() === 'm2'"
                                        (click)="setSimpleInputMode('m2')">
                                        m¬≤
                                    </button>
                                </div>

                                @if (simpleInputMode() === 'tables') {
                                    <label>
                                        Tables :
                                        <input
                                            type="number"
                                            [ngModel]="simpleTablesInput()"
                                            (ngModelChange)="onSimpleTablesInputChange($event)"
                                            min="0"
                                            step="1">
                                    </label>
                                } @else {
                                    <label>
                                        m¬≤ :
                                        <input
                                            type="number"
                                            [ngModel]="simpleM2Input()"
                                            (ngModelChange)="onSimpleM2InputChange($event)"
                                            min="0"
                                            step="0.5">
                                        <small class="hint-text">= {{ simpleTablesInput() }} table(s)</small>
                                    </label>
                                }

                                <p class="tables-calculees">
                                    üìä Tables calcul√©es : <strong>{{ simpleTablesInput() }}</strong>
                                    ({{ tablesToM2(simpleTablesInput()) | number:'1.1-1' }} m¬≤)
                                </p>

                                <div class="chaises-section">
                                    <label>
                                        ü™ë Chaises :
                                        <input
                                            type="number"
                                            [ngModel]="simpleChaisesInput()"
                                            (ngModelChange)="onSimpleChaisesInputChange($event)"
                                            min="0"
                                            step="1"
                                            max="{{ simpleChaisesDisponibles() }}">
                                    </label>
                                    <small class="hint-text">
                                        Disponibles : {{ simpleChaisesDisponibles() }} / {{ chaisesStock().total }}
                                    </small>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" (click)="closeAllocationModal()">Annuler</button>
                        @if (isGameMode()) {
                            <button class="btn-confirm" 
                                    (click)="allocateGame()" 
                                    [disabled]="!selectedGame() || loading() || 
                                        tablesCalculees() > tablesRestantesParZone()[selectedZone()!.id] || 
                                        (selectedZone() && tablesCalculees() > quotaRestantPourZone(selectedZone()!)) || 
                                        stockInsuffisant()">
                                {{ loading() ? 'Allocation...' : 'Allouer le jeu' }}
                            </button>
                        } @else {
                            <button class="btn-confirm"
                                    (click)="saveSimpleAllocation()"
                                    [disabled]="loading() || (simpleTablesInput() <= 0 && simpleChaisesInput() <= 0) || simpleTablesInput() > tablesDisponiblesPourZone(selectedZone()!)">
                                {{ loading() ? 'Allocation...' : 'Affecter' }}
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>
