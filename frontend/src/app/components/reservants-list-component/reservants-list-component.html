<div class="reservants-page">
  <header class="page-header">
    <div class="titles">
      <p class="eyebrow">Réservants</p>
      <h1>Liste des réservants</h1>
      <p class="subtitle">Visualisez les contacts et accédez rapidement à leurs fiches.</p>
    </div>
    <button class="primary" routerLink="/reservants/new">Créer un réservant</button>
  </header>

  <section class="toolbar">

      <label class="field">
        <span>Nom du réservant: </span>
        <div class="search-box">  
          <input 
            type="text" 
            placeholder="Rechercher un réservant..." 
            (input)="setSearchQuery($any($event.target).value)"
            class="search-input"
          >
        </div>
      </label>

    <label class="field">
      <span>Type</span>
      <select [value]="typeFilter()" (change)="setTypeFilter($any($event.target).value)">
        <option value="all">Tous les types</option>
        <option value="editeur">Editeur</option>
        <option value="prestataire">Prestataire</option>
        <option value="boutique">Boutique</option>
        <option value="animateur">Animateur</option>
        <option value="association">Association</option>
      </select>
    </label>

    <label class="field">
      <span>Trier par</span>
      <select [value]="sortKey()" (change)="setSortKey($any($event.target).value)">
        <option value="name-asc">Nom (A -> Z)</option>
        <option value="name-desc">Nom (Z -> A)</option>
      </select>
    </label>
  </section>

  @if (error()) {
    <p class="error">{{ error() }}</p>
  }

  <!-- Bloc conditionnel principal -->
  @if (reservantsView().length === 0) {
    <div class="empty-state">
      <p>Aucun réservant pour le moment.</p>
      <button class="ghost" routerLink="/reservants/new">Créer un réservant</button>
    </div>
  } @else {
    <div class="table">
      <div class="table-head">
        <span>Nom</span>
        <span>Type</span>
        <span>Contact</span>
        <span class="actions-col">Actions</span>
      </div>

      @for (r of reservantsView(); track r.id) {
        <div class="table-row">
          <div class="cell">
            <div class="name">{{ r.name }}</div>
          </div>
          <div class="cell">
            <span class="badge">{{ r.type }}</span>
          </div>
          <div class="cell contact">
            {{ contactInfo(r) }}
          </div>
          <div class="cell actions">
            <button class="ghost" [routerLink]="['/reservants', r.id]">Voir</button>
            <button class="ghost" [routerLink]="['/reservants', r.id, 'edit']">Modifier</button>
            @if (canDeleteReservant()) {
              <button type="button" class="ghost danger" (click)="requestDelete(r)">Supprimer</button>
            }
          </div>
        </div>
      }
    </div>
  }

  @if (pendingDelete()) {
    <div class="modal-backdrop" (click)="cancelDelete()"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="delete-title">
      <h3 id="delete-title">Confirmation</h3>
      <p class="muted">{{ deletePrompt() }}</p>
      <p class="muted warning">
        Cette suppression entrainera la suppression des donnees liees au reservant.
      </p>

      @if (deleteSummaryLoading()) {
        <p class="muted">Chargement des dependances...</p>
      }

      @if (deleteSummaryError()) {
        <p class="error">{{ deleteSummaryError() }}</p>
      }

      @if (deleteSummaryForPending(); as summary) {
        <div class="delete-summary">
          <div class="summary-section">
            <h4>Contacts ({{ summary.contacts.length }})</h4>
            @if (summary.contacts.length === 0) {
              <p class="muted">Aucun contact associe.</p>
            } @else {
              <div class="summary-list">
                @for (contact of summary.contacts; track contact.id) {
                  <p>{{ contact.name }} · {{ contact.email }}</p>
                }
              </div>
            }
          </div>

          <div class="summary-section">
            <h4>Reservations ({{ summary.reservations.length }})</h4>
            @if (summary.reservations.length === 0) {
              <p class="muted">Aucune reservation associee.</p>
            } @else {
              <div class="summary-list">
                @for (reservation of summary.reservations; track reservation.id) {
                  <p>
                    #{{ reservation.id }}
                    @if (reservation.festival_name) { · {{ reservation.festival_name }} }
                    · {{ reservation.relation === 'represented_editor' ? 'Editeur represente' : 'Reservant principal' }}
                  </p>
                }
              </div>
            }
          </div>

          <div class="summary-section">
            <h4>Workflows ({{ summary.workflows.length }})</h4>
            @if (summary.workflows.length === 0) {
              <p class="muted">Aucun workflow associe.</p>
            } @else {
              <div class="summary-list">
                @for (workflow of summary.workflows; track workflow.id) {
                  <p>
                    #{{ workflow.id }}
                    @if (workflow.festival_name) { · {{ workflow.festival_name }} }
                  </p>
                }
              </div>
            }
          </div>

          <p class="muted">
            Les allocations liees aux reservations (jeux alloues, zones tarifaires, zones plan) seront aussi supprimees.
          </p>
        </div>
      }
      <div class="modal-actions">
        <button type="button" class="ghost" (click)="cancelDelete()">Annuler</button>
        <button type="button" class="danger" (click)="confirmDelete()">Supprimer</button>
      </div>
    </div>
  }
</div>
