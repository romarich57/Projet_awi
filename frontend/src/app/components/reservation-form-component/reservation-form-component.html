<div class="reservation-form">
    <h2>Nouvelle Réservation</h2>
    @if (festivalName()) {
        <h3>Festival: {{ festivalName() }}</h3>
    }
    
    @if (showSuccessMessage) {
        <div class="success-message">
            <p>✅ Réservation créée avec succès!</p>
        </div>
    } @else {
        <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()">
            <!-- Choix du mode de réservant -->
            <div class="form-card">
                <h4>Réservant</h4>
                
                <!-- Sélecteur de mode -->
                <div class="mode-selector">
                    <label class="radio-option">
                        <input 
                            type="radio" 
                            value="new"
                            formControlName="reservant_mode"
                            (change)="onModeChange()"
                        >
                        <span>Créer un nouveau réservant</span>
                    </label>
                    <label class="radio-option">
                        <input 
                            type="radio" 
                            value="existing"
                            formControlName="reservant_mode"
                            (change)="onModeChange()"
                        >
                        <span>Choisir un réservant existant</span>
                    </label>
                </div>

                <!-- Sélection d'un réservant existant -->
                @if (isExistingMode) {
                    <div class="existing-reservant-section">
                        @if (loadingReservants) {
                            <p>Chargement des réservants...</p>
                        } @else {
                            <label class="field full">
                                <span>Sélectionner un réservant *</span>
                                <select formControlName="existing_reservant_id">
                                    <option value="">-- Choisir un réservant --</option>
                                    @for (reservant of existingReservants; track reservant.id) {
                                        <option [value]="reservant.id">
                                            {{ reservant.name }} ({{ reservant.type }}) - {{ reservant.email }}
                                        </option>
                                    }
                                </select>
                                @if (reservationForm.get('existing_reservant_id')?.touched && reservationForm.get('existing_reservant_id')?.errors) {
                                    <small class="error">Veuillez sélectionner un réservant</small>
                                }
                            </label>
                        }
                    </div>
                }

                <!-- Création d'un nouveau réservant -->
                @if (!isExistingMode) {
                    <div class="new-reservant-section">
                        <div class="grid">
                            <label class="field">
                                <span>Nom du réservant *</span>
                                <input 
                                    type="text" 
                                    formControlName="reservant_name" 
                                    placeholder="Nom ou raison sociale"
                                >
                                @if (reservationForm.get('reservant_name')?.touched && reservationForm.get('reservant_name')?.errors) {
                                    <small class="error">Le nom est requis</small>
                                }
                            </label>

                            <label class="field">
                                <span>Email *</span>
                                <input 
                                    type="email" 
                                    formControlName="reservant_email" 
                                    placeholder="email@example.com"
                                >
                                @if (reservationForm.get('reservant_email')?.touched && reservationForm.get('reservant_email')?.errors) {
                                    <small class="error">Un email valide est requis</small>
                                }
                            </label>

                            <label class="field">
                                <span>Type de réservant *</span>
                                <select formControlName="reservant_type">
                                    <option value="editeur">Éditeur</option>
                                    <option value="prestataire">Prestataire</option>
                                    <option value="boutique">Boutique</option>
                                    <option value="animateur">Animateur</option>
                                    <option value="association">Association</option>
                                </select>
                            </label>

                            <label class="field">
                                <span>Téléphone</span>
                                <input 
                                    type="tel" 
                                    formControlName="phone_number" 
                                    placeholder="0123456789"
                                >
                            </label>

                            <label class="field full">
                                <span>Adresse</span>
                                <textarea 
                                    formControlName="address" 
                                    placeholder="Adresse complète"
                                    rows="3"
                                ></textarea>
                            </label>

                            <label class="field">
                                <span>SIRET</span>
                                <input 
                                    type="text" 
                                    formControlName="siret" 
                                    placeholder="12345678901234"
                                >
                            </label>
                        </div>
                    </div>
                }

                <!-- Notes (disponible dans tous les modes) -->
                <div class="notes-section">
                    <label class="field full">
                        <span>Notes</span>
                        <textarea 
                            formControlName="note" 
                            placeholder="Informations complémentaires sur la réservation"
                            rows="3"
                        ></textarea>
                    </label>
                </div>
                
                <p class="info-text">Les prix seront définis à 0 par défaut et pourront être modifiés ultérieurement.</p>
            </div>

            <!-- NOUVELLE SECTION : Type de réservation -->
            <div class="form-card">
                <h4>Type de réservation</h4>
                <div class="mode-selector">
                    <label class="radio-option">
                        <input 
                            type="radio" 
                            value="table"
                            formControlName="reservation_type"
                        >
                        <span>Au MATÉRIEL (par nombre de tables)</span>
                    </label>
                    <label class="radio-option">
                        <input 
                            type="radio" 
                            value="m2"
                            formControlName="reservation_type"
                        >
                        <span>À la SURFACE (au m²)</span>
                    </label>
                </div>
            </div>

            <!-- NOUVELLE SECTION : Zones tarifaires -->
            <div class="form-card">
                <h4>Zones tarifaires</h4>
                
                @if (loadingZones) {
                    <p>Chargement des zones tarifaires...</p>
                } @else if (zonesTarifaires().length === 0) {
                    <p class="info">Aucune zone tarifaire disponible pour ce festival</p>
                } @else {
                    <!-- Sélecteur pour ajouter une zone -->
                    <div class="add-zone-section">
                        <label class="field">
                            <span>Sélectionner une zone tarifaire</span>
                            <select formControlName="selected_zone_id">
                                <option value="">-- Choisir une zone --</option>
                                @for (zone of zonesTarifaires(); track zone.id) {
                                    <option [value]="zone.id">
                                        {{ zone.name }} 
                                        ({{ zone.price_per_table }}€/table, {{ zone.m2_price }}€/m²)
                                        - Disponible: {{ zone.nb_tables_available }} tables
                                    </option>
                                }
                            </select>
                        </label>
                        
                        <!-- Champs selon le type de réservation -->
                        @if (reservationForm.get('reservation_type')?.value === 'table') {
                            <div class="temp-fields">
                                <label class="field">
                                    <span>Tables standard</span>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        formControlName="temp_tables_standard"
                                    >
                                </label>
                                <label class="field">
                                    <span>Tables grande</span>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        formControlName="temp_tables_grande"
                                    >
                                </label>
                                <label class="field">
                                    <span>Tables mairie</span>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        formControlName="temp_tables_mairie"
                                    >
                                </label>
                                <label class="field">
                                    <span>Chaises (gratuit)</span>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        formControlName="temp_chaises"
                                    >
                                </label>
                            </div>
                        } @else {
                            <div class="temp-fields">
                                <label class="field full">
                                    <span>Surface nécessaire (m²)</span>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        step="0.5"
                                        formControlName="temp_surface_m2"
                                    >
                                </label>
                            </div>
                        }
                        
                        <button 
                            type="button" 
                            class="add-zone-btn"
                            (click)="addZone()"
                            [disabled]="!reservationForm.get('selected_zone_id')?.value"
                        >
                            + Ajouter cette zone
                        </button>
                    </div>

                    <!-- Liste des zones ajoutées -->
                    <div class="zones-list">
                        <h5>Zones sélectionnées</h5>
                        
                        @if (zonesArray.length === 0) {
                            <p class="info">Aucune zone ajoutée. Ajoutez au moins une zone.</p>
                        }
                        
                        @for (zoneGroup of zonesArray.controls; track zoneGroup.value.zone_tarifaire_id || $index; let i = $index) {
                            <div class="zone-item">
                                <div class="zone-header">
                                    <h6>
                                        {{ getZoneName(zoneGroup.value.zone_tarifaire_id) }}
                                        <span class="zone-price">
                                            {{ calculateZonePrice(zoneGroup.value) }} €
                                        </span>
                                    </h6>
                                    <button 
                                        type="button" 
                                        class="remove-zone-btn"
                                        (click)="removeZone(i)"
                                    >
                                        × Supprimer
                                    </button>
                                </div>
                                
                                <div class="zone-details">
                                    @if (zoneGroup.value.mode_paiement === 'table') {
                                        <div class="zone-info">
                                            <span>Tables standard: {{ zoneGroup.value.nb_tables_standard || 0 }}</span>
                                            <span>Tables grande: {{ zoneGroup.value.nb_tables_grande || 0 }}</span>
                                            <span>Tables mairie: {{ zoneGroup.value.nb_tables_mairie || 0 }}</span>
                                            <span>Chaises: {{ zoneGroup.value.nb_chaises || 0 }}</span>
                                        </div>
                                    } @else {
                                        <div class="zone-info">
                                            <span>Surface: {{ zoneGroup.value.surface_m2 || 0 }} m²</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- NOUVELLE SECTION : Récapitulatif du prix -->
            <div class="form-card price-summary">
                <h4>Récapitulatif</h4>
                
                <div class="price-display">
                    <div class="total-price">
                        <span class="label">Prix estimé :</span>
                        <span class="value">{{ calculatedPrice() }} €</span>
                    </div>
                    
                    <div class="equivalents">
                        <small>
                            Équivalent : {{ totalTablesEquivalent() }} tables / {{ totalM2Equivalent() }} m²
                        </small>
                    </div>
                    
                    <div class="price-formula">
                        <small>
                            Prix BRUT = 
                            @if (reservationForm.get('reservation_type')?.value === 'table') {
                                (tables × prix_table)
                            } @else {
                                (m² × prix_m²)
                            }
                        </small>
                    </div>
                </div>
            </div>

            <!-- MODIFIEZ LE BOUTON SUBMIT POUR VALIDER LES ZONES -->
            <div class="form-actions">
                <button type="button" class="cancel-btn" (click)="cancel()" [disabled]="isSubmitting">
                    Annuler
                </button>
                <button 
                    type="submit" 
                    class="submit-btn" 
                    [disabled]="isSubmitting || reservationForm.invalid || zonesArray.length === 0"
                >
                    @if (isSubmitting) {
                        Création en cours...
                    } @else {
                        Créer la réservation
                    }
                </button>
            </div>
            
        </form>
    }
</div>