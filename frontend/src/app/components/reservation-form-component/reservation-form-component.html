<div class="reservation-form">
    <h2>Nouvelle Réservation</h2>
    <!-- Bloc conditionnel principal -->
    @if (festivalName()) {
        <h3>Festival: {{ festivalName() }}</h3>
    }
    
    @if (showSuccessMessage) {
        <div class="success-message">
            <p>✅ Réservation créée avec succès!</p>
        </div>
    } @else {
        <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()">
            <!-- Choix du mode de réservant -->
            <div class="form-card">
                <h4>Réservant</h4>
                
                <!-- Sélecteur de mode -->
                <div class="mode-selector">
                    <label class="radio-option">
                        <input 
                            type="radio" 
                            value="new"
                            formControlName="reservant_mode"
                            (change)="onModeChange()"
                            [disabled]="readOnly()"
                        >
                        <span>Créer un nouveau réservant</span>
                    </label>
                    <label class="radio-option">
                        <input 
                            type="radio" 
                            value="existing"
                            formControlName="reservant_mode"
                            (change)="onModeChange()"
                            [disabled]="readOnly()"
                        >
                        <span>Choisir un réservant existant</span>
                    </label>
                </div>

                <!-- Sélection d'un réservant existant -->
                @if (isExistingMode) {
                    <div class="existing-reservant-section">
                        @if (loadingReservants) {
                            <p>Chargement des réservants...</p>
                        } @else {
                            <label class="field full">
                                <span>Sélectionner un réservant *</span>
                                <select formControlName="existing_reservant_id" [disabled]="readOnly()" (change)="onExistingReservantChange()">
                                    <option value="">-- Choisir un réservant --</option>
                                    @for (reservant of existingReservants; track reservant.id) {
                                        <option [value]="reservant.id">
                                            {{ reservant.name }} ({{ reservant.type }}) - {{ reservant.email }}
                                        </option>
                                    }
                                </select>
                                @if (reservationForm.get('existing_reservant_id')?.touched && reservationForm.get('existing_reservant_id')?.errors) {
                                    <small class="error">Veuillez sélectionner un réservant</small>
                                }
                            </label>
                        }
                    </div>
                }

                <!-- Création d'un nouveau réservant -->
                @if (!isExistingMode) {
                    <div class="new-reservant-section">
                        <div class="grid">
                            <label class="field">
                                <span>Nom du réservant *</span>
                                <input 
                                    type="text" 
                                    formControlName="reservant_name" 
                                    placeholder="Nom ou raison sociale"
                                    [readonly]="readOnly()"
                                >
                                @if (reservationForm.get('reservant_name')?.touched && reservationForm.get('reservant_name')?.errors) {
                                    <small class="error">Le nom est requis</small>
                                }
                            </label>

                            <label class="field">
                                <span>Email *</span>
                                <input 
                                    type="email" 
                                    formControlName="reservant_email" 
                                    placeholder="email@example.com"
                                    [readonly]="readOnly()"
                                >
                                @if (reservationForm.get('reservant_email')?.touched && reservationForm.get('reservant_email')?.errors) {
                                    <small class="error">Un email valide est requis</small>
                                }
                            </label>

                            <label class="field">
                                <span>Type de réservant *</span>
                                <select formControlName="reservant_type" [disabled]="readOnly()" (change)="onReservantTypeChange()">
                                    <option value="editeur">Éditeur</option>
                                    <option value="prestataire">Prestataire</option>
                                    <option value="boutique">Boutique</option>
                                    <option value="animateur">Animateur</option>
                                    <option value="association">Association</option>
                                </select>
                            </label>

                            <label class="field">
                                <span>Téléphone</span>
                                <input 
                                    type="tel" 
                                    formControlName="phone_number" 
                                    placeholder="0123456789"
                                    [readonly]="readOnly()"
                                >
                            </label>

                            <label class="field full">
                                <span>Adresse</span>
                                <textarea 
                                    formControlName="address" 
                                    placeholder="Adresse complète"
                                    rows="3"
                                    [readonly]="readOnly()"
                                ></textarea>
                            </label>

                            <label class="field">
                                <span>SIRET</span>
                                <input 
                                    type="text" 
                                    formControlName="siret" 
                                    placeholder="12345678901234"
                                    [readonly]="readOnly()"
                                >
                            </label>
                        </div>
                    </div>
                }

                @if (shouldShowRepresentedEditorQuestion()) {
                    <div class="represent-editor-section">
                        <label class="field full">
                            <span>Représentez-vous un éditeur ?</span>
                            <select formControlName="represent_editor" [disabled]="readOnly()" (change)="onRepresentEditorChange()">
                                <option value="no">Non</option>
                                <option value="yes">Oui</option>
                            </select>
                        </label>

                        @if (reservationForm.get('represent_editor')?.value === 'yes') {
                            <label class="field full">
                                <span>Éditeur représenté *</span>
                                <select formControlName="represented_editor_id" [disabled]="readOnly()">
                                    <option value="">-- Choisir un éditeur --</option>
                                    @for (reservant of editorReservants; track reservant.id) {
                                        <option [value]="reservant.id">
                                            {{ reservant.name }} - {{ reservant.email }}
                                        </option>
                                    }
                                </select>
                                @if (reservationForm.get('represented_editor_id')?.touched && reservationForm.get('represented_editor_id')?.errors) {
                                    <small class="error">Veuillez sélectionner un éditeur</small>
                                }
                            </label>
                        }
                    </div>
                }

                <!-- Notes (disponible dans tous les modes) -->
                <div class="notes-section">
                    <label class="field full">
                        <span>Notes</span>
                        <textarea 
                            formControlName="note" 
                            placeholder="Informations complémentaires sur la réservation"
                            rows="3"
                            [readonly]="readOnly()"
                        ></textarea>
                    </label>
                </div>
                
                <p class="info-text">Les prix seront définis à 0 par défaut et pourront être modifiés ultérieurement.</p>
            </div>





            <div class="form-actions">
                <button type="button" class="cancel-btn" (click)="cancel()" [disabled]="isSubmitting">
                    {{ readOnly() ? 'Fermer' : 'Annuler' }}
                </button>
                @if (!readOnly()) {
                    <button type="submit" class="submit-btn" [disabled]="isSubmitting || reservationForm.invalid">
                        @if (isSubmitting) {
                            Création en cours...
                        } @else {
                            Créer la réservation
                        }
                    </button>
                }
            </div>
        </form>
    }
</div>
