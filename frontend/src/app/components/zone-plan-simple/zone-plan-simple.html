<h3>Zone et plan simple</h3>
<div class="zone-plan-simple-container">
  @if (festivalId()) {
    @if (!reservation()) {
      <p class="empty-message">Chargement de la r√©servation...</p>
    } @else {
      <div class="zones-list">
        <h4>üìç Zones de plan</h4>
        @for (zone of zonePlans(); track zone.id) {
          <div class="zone-card">
            <div class="zone-header">
              <div class="zone-info">
                <span class="zone-name">{{ zone.name }}</span>
                <span class="zone-tarifaire">{{ zone.zone_tarifaire_name }}</span>
              </div>
              <div class="zone-stats">
                <span class="tables-count">
                  üìä {{ totalAlloueesParZone()[zone.id] || 0 }} / {{ zone.nb_tables }} tables (global)
                </span>
                <span class="tables-restantes" [class.warning]="tablesDisponiblesPourZone(zone) <= 2" [class.danger]="tablesDisponiblesPourZone(zone) <= 0">
                  ({{ tablesDisponiblesPourZone(zone) }} dispo pour ce r√©servant)
                </span>
              </div>
              <div class="zone-actions">
                <button class="btn-allocate" (click)="openAllocationModal(zone)" [disabled]="!isZoneEligible(zone)">
                  ‚ûï Affecter
                </button>
                <button class="btn-edit" (click)="openEditForm(zone)">‚úèÔ∏è</button>
                <button class="btn-delete" (click)="deleteZonePlan(zone.id)" [disabled]="(tablesAlloueesParZone()[zone.id] || 0) > 0">üóëÔ∏è</button>
              </div>
            </div>
            <div class="zone-content">
              @if (isZoneEligible(zone)) {
                @if ((tablesAlloueesParZone()[zone.id] || 0) > 0) {
                  <p class="allocation-summary">
                    R√©serv√© pour ce r√©servant : {{ tablesAlloueesParZone()[zone.id] }} table(s)
                    ({{ tablesToM2(tablesAlloueesParZone()[zone.id]) | number:'1.1-1' }} m¬≤)
                  </p>
                  <button class="btn-remove" (click)="removeAllocation(zone)">Retirer</button>
                } @else {
                  <p class="empty-zone">Aucune table affect√©e pour ce r√©servant.</p>
                }
              } @else {
                <p class="empty-zone warning-message">
                  ‚ö†Ô∏è Cette zone est li√©e √† une zone tarifaire non r√©serv√©e par ce r√©servant.
                </p>
              }
            </div>
          </div>
        } @empty {
          <p>Aucune zone associ√©e √† ce festival.</p>
        }
      </div>

      <button class="add-zone-button" (click)="openForm()">‚ûï Ajouter une zone</button>

      @if (showForm()) {
        <app-zone-plan-form
          [festivalId]="festivalId()!"
          [zoneTarifaires]="zoneTarifaires()"
          [tablesRestantes]="tablesRestantesParZoneTarifaire()"
          [zonePlanToEdit]="zonePlanToEdit()"
          (formClosed)="closeForm()"
          (zonePlanCreated)="onZonePlanCreated()">
        </app-zone-plan-form>
      }

      @if (showAllocationModal()) {
        <div class="modal-overlay" (click)="closeAllocationModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Affecter des tables √† : {{ selectedZone()?.name }}</h3>
              <button class="btn-close" (click)="closeAllocationModal()">‚úï</button>
            </div>
            <div class="modal-body">
              <p>Tables r√©serv√©es dans la zone tarifaire :
                <strong>{{ tablesReserveesParZoneTarifaire()[selectedZone()!.id_zone_tarifaire] || 0 }}</strong>
              </p>
              <p>Tables disponibles pour ce r√©servant :
                <strong>{{ tablesDisponiblesPourZone(selectedZone()!) }}</strong>
              </p>

              <div class="allocation-options">
                <div class="input-toggle">
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="inputMode() === 'tables'"
                    (click)="setInputMode('tables')">
                    Tables
                  </button>
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="inputMode() === 'm2'"
                    (click)="setInputMode('m2')">
                    m¬≤
                  </button>
                </div>

                @if (inputMode() === 'tables') {
                  <label>
                    Tables :
                    <input
                      type="number"
                      [ngModel]="tablesInput()"
                      (ngModelChange)="onTablesInputChange($event)"
                      min="0"
                      step="1">
                  </label>
                } @else {
                  <label>
                    m¬≤ :
                    <input
                      type="number"
                      [ngModel]="m2Input()"
                      (ngModelChange)="onM2InputChange($event)"
                      min="0"
                      step="0.5">
                    <small class="hint-text">= {{ tablesInput() }} table(s)</small>
                  </label>
                }

                <p class="tables-calculees">
                  üìä Tables calcul√©es : <strong>{{ tablesInput() }}</strong>
                  ({{ tablesToM2(tablesInput()) | number:'1.1-1' }} m¬≤)
                </p>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn-cancel" (click)="closeAllocationModal()">Annuler</button>
              <button class="btn-confirm"
                      (click)="saveAllocation()"
                      [disabled]="loading() || tablesInput() <= 0 || tablesInput() > tablesDisponiblesPourZone(selectedZone()!)">
                {{ loading() ? 'Allocation...' : 'Affecter' }}
              </button>
            </div>
          </div>
        </div>
      }
    }
  }
</div>
