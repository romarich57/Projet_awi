<div class="zone-plan-simple-container">
  @if (festivalId()) {
    @if (!reservation()) {
      <p class="empty-message">Chargement de la rÃ©servation...</p>
    } @else {
      <!-- Stock global de chaises -->
      <div class="chaises-stock-global">
        <span class="chaises-label">ğŸª‘ Stock chaises festival :</span>
        <span class="chaises-count" [class.low-stock]="chaisesStock().available <= 10">
          {{ chaisesStock().available }} disponibles / {{ chaisesStock().total }} total
        </span>
      </div>

      <div class="zones-list">
        <h4>ğŸ“ Zones de plan</h4>
        @for (zone of zonePlans(); track zone.id) {
          <div class="zone-card">
            <div class="zone-header">
              <div class="zone-info">
                <span class="zone-name">{{ zone.name }}</span>
                <span class="zone-tarifaire">{{ zone.zone_tarifaire_name }}</span>
              </div>
              <div class="zone-stats">
                <span class="tables-count">
                  ğŸ“Š {{ totalAlloueesParZone()[zone.id] || 0 }} / {{ zone.nb_tables }} tables (global)
                </span>
                <span class="tables-restantes" [class.warning]="tablesDisponiblesPourZone(zone) <= 2" [class.danger]="tablesDisponiblesPourZone(zone) <= 0">
                  ({{ tablesDisponiblesPourZone(zone) }} dispo pour ce rÃ©servant)
                </span>
              </div>
              <div class="zone-actions">
                <button class="btn-allocate" (click)="openAllocationModal(zone)" [disabled]="!isZoneEligible(zone)">
                  â• Affecter
                </button>
                <button class="btn-edit" (click)="openEditForm(zone)">âœï¸</button>
                <button class="btn-delete" (click)="deleteZonePlan(zone.id)" [disabled]="(tablesAlloueesParZone()[zone.id] || 0) > 0">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="zone-content">
              @if (isZoneEligible(zone)) {
                @if ((tablesAlloueesParZone()[zone.id] || 0) > 0 || (chaisesAlloueesParZone()[zone.id] || 0) > 0) {
                  <p class="allocation-summary">
                    RÃ©servÃ© pour ce rÃ©servant : 
                    @if ((tablesAlloueesParZone()[zone.id] || 0) > 0) {
                      {{ tablesAlloueesParZone()[zone.id] }} table(s)
                      ({{ tablesToM2(tablesAlloueesParZone()[zone.id]) | number:'1.1-1' }} mÂ²)
                    }
                    @if ((chaisesAlloueesParZone()[zone.id] || 0) > 0) {
                      @if ((tablesAlloueesParZone()[zone.id] || 0) > 0) { + }
                      {{ chaisesAlloueesParZone()[zone.id] }} chaise(s) ğŸª‘
                    }
                  </p>
                  <button class="btn-remove" (click)="removeAllocation(zone)">Retirer</button>
                } @else {
                  <p class="empty-zone">Aucune table affectÃ©e pour ce rÃ©servant.</p>
                }
              } @else {
                <p class="empty-zone warning-message">
                  âš ï¸ Cette zone est liÃ©e Ã  une zone tarifaire non rÃ©servÃ©e par ce rÃ©servant.
                </p>
              }
            </div>
          </div>
        } @empty {
          <p class="empty-zone">Aucune zone associÃ©e Ã  ce festival.</p>
        }
      </div>

      <button class="add-zone-button" (click)="openForm()">â• Ajouter une zone</button>

      @if (showForm()) {
        <app-zone-plan-form
          [festivalId]="festivalId()!"
          [zoneTarifaires]="zoneTarifaires()"
          [tablesRestantes]="tablesRestantesParZoneTarifaire()"
          [zonePlanToEdit]="zonePlanToEdit()"
          (formClosed)="closeForm()"
          (zonePlanCreated)="onZonePlanCreated()">
        </app-zone-plan-form>
      }

      @if (showAllocationModal()) {
        <div class="modal-overlay" (click)="closeAllocationModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Affecter des tables Ã  : {{ selectedZone()?.name }}</h3>
              <button class="btn-close" (click)="closeAllocationModal()">âœ•</button>
            </div>
            <div class="modal-body">
              <p>Tables rÃ©servÃ©es dans la zone tarifaire :
                <strong>{{ tablesReserveesParZoneTarifaire()[selectedZone()!.id_zone_tarifaire] || 0 }}</strong>
              </p>
              <p>Tables disponibles pour ce rÃ©servant :
                <strong>{{ tablesDisponiblesPourZone(selectedZone()!) }}</strong>
              </p>

              <div class="allocation-options">
                <div class="input-toggle">
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="inputMode() === 'tables'"
                    (click)="setInputMode('tables')">
                    Tables
                  </button>
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="inputMode() === 'm2'"
                    (click)="setInputMode('m2')">
                    mÂ²
                  </button>
                </div>

                @if (inputMode() === 'tables') {
                  <label>
                    Tables :
                    <input
                      type="number"
                      [ngModel]="tablesInput()"
                      (ngModelChange)="onTablesInputChange($event)"
                      min="0"
                      step="1">
                  </label>
                } @else {
                  <label>
                    mÂ² :
                    <input
                      type="number"
                      [ngModel]="m2Input()"
                      (ngModelChange)="onM2InputChange($event)"
                      min="0"
                      step="0.5">
                    <small class="hint-text">= {{ tablesInput() }} table(s)</small>
                  </label>
                }

                <p class="tables-calculees">
                  ğŸ“Š Tables calculÃ©es : <strong>{{ tablesInput() }}</strong>
                  ({{ tablesToM2(tablesInput()) | number:'1.1-1' }} mÂ²)
                </p>

                <!-- Chaises -->
                <div class="chaises-section">
                  <label>
                    ğŸª‘ Chaises :
                    <input
                      type="number"
                      [ngModel]="chaisesInput()"
                      (ngModelChange)="onChaisesInputChange($event)"
                      min="0"
                      step="1">
                  </label>
                  <small class="hint-text">
                    Disponibles : {{ chaisesDisponibles() }} / {{ chaisesStock().total }}
                  </small>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn-cancel" (click)="closeAllocationModal()">Annuler</button>
              <button class="btn-confirm"
                      (click)="saveAllocation()"
                      [disabled]="loading() || (tablesInput() <= 0 && chaisesInput() <= 0) || tablesInput() > tablesDisponiblesPourZone(selectedZone()!)">
                {{ loading() ? 'Allocation...' : 'Affecter' }}
              </button>
            </div>
          </div>
        </div>
      }
    }
  }
</div>
