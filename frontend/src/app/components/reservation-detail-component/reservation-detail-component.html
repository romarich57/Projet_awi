<div class="reservation-detail">
  <!-- Bloc conditionnel principal -->
  @if (loading()) {
    <div class="loading">Chargement...</div>
  } @else if (reservation()) {
    <!-- Informations du réservant -->
    <div class="reservant-info">
      <h3>Réservant</h3>
      <p><strong>Nom :</strong> {{ reservation()!.reservant_name }}</p>
      <p><strong>Email :</strong> {{ reservation()!.reservant_email }}</p>
      <p><strong>Type :</strong> {{ reservation()!.reservant_type }}</p>
      <p><strong>Festival :</strong> {{ reservation()!.festival_name }}</p>
    </div>

    <!-- Zones tarifaires -->
    <div class="zones-section">
      <h3>Zones tarifaires</h3>
      <p class="section-description">Choisissez le nombre de tables ou les m² par zone tarifaire</p>
      
      <div class="zones-list">
        @for (zone of zones(); track zone.zone_tarifaire_id) {
          <div class="zone-item">
            <div class="zone-info">
              <span class="zone-name">{{ zone.name }}</span>
              <span class="zone-price">
                {{ zone.price_per_table | currency:'EUR':'symbol':'1.0-2' }} / table
                ({{ zone.price_per_m2 | currency:'EUR':'symbol':'1.2-2' }} / m²)
              </span>
              <span class="zone-availability">
                Disponibles : {{ zone.available_tables - zone.nb_tables_reservees }} / {{ zone.total_tables }} tables
                ({{ tablesToM2(zone.available_tables - zone.nb_tables_reservees) | number:'1.1-1' }} m²)
              </span>
            </div>
            <div class="zone-input">
              <div class="input-toggle">
                <button 
                  type="button" 
                  class="toggle-btn"
                  [class.active]="zone.inputMode === 'tables'"
                  (click)="toggleInputMode(zone.zone_tarifaire_id)"
                  [disabled]="readOnly()"
                >
                  {{ zone.inputMode === 'tables' ? 'Tables' : 'm²' }}
                </button>
              </div>
              @if (zone.inputMode === 'tables') {
                <label>Tables :</label>
                <input 
                  type="number" 
                  [value]="zone.nb_tables_reservees"
                  [min]="0"
                  [max]="zone.available_tables"
                  (input)="onTablesChange(zone.zone_tarifaire_id, $event)"
                  [readonly]="readOnly()"
                />
              } @else {
                <label>m² :</label>
                <input 
                  type="number" 
                  [value]="zone.m2_value"
                  [min]="0"
                  [max]="tablesToM2(zone.available_tables)"
                  [step]="0.5"
                  (input)="onM2Change(zone.zone_tarifaire_id, $event)"
                  [readonly]="readOnly()"
                />
                <span class="conversion-info">
                  (= {{ zone.nb_tables_reservees }} tables, max {{ tablesToM2(zone.available_tables) | number:'1.1-1' }} m²)
                </span>
              }
              <span class="subtotal">
                = {{ (zone.nb_tables_reservees * zone.price_per_table) | currency:'EUR':'symbol':'1.0-2' }}
              </span>
            </div>
          </div>
        } @empty {
          <p class="no-zones">Aucune zone tarifaire disponible pour ce festival.</p>
        }
      </div>
    </div>

    <!-- Nombre de prises -->
    <div class="prises-section">
      <h3>Prises électriques</h3>
      <div class="prises-input">
        <label>Nombre de prises :</label>
        <input 
          type="number" 
          [value]="nbPrises()"
          [min]="0"
          (input)="onPrisesChange($event)"
          [readonly]="readOnly()"
        />
        <span class="price-info">{{ prixParPrise | currency:'EUR':'symbol':'1.0-2' }} / prise</span>
        <span class="subtotal">
          = {{ (nbPrises() * prixParPrise) | currency:'EUR':'symbol':'1.0-2' }}
        </span>
      </div>
    </div>

    <!-- Remises -->
    <div class="discounts-section">
      <h3>Remises</h3>
      
      <div class="discount-input">
        <label>Tables offertes :</label>
        <input 
          type="number" 
          [value]="tableDiscountOffered()"
          [min]="0"
          [max]="totalTables()"
          (input)="onTableDiscountChange($event)"
          [readonly]="readOnly()"
        />
        <span class="price-info">
          @if (tableDiscountAmount() > 0) {
            - {{ tableDiscountAmount() | currency:'EUR':'symbol':'1.2-2' }}
          } @else {
            (aucune)
          }
        </span>
      </div>

      <div class="discount-input">
        <label>Remise directe (€) :</label>
        <input 
          type="number" 
          [value]="directDiscount()"
          [min]="0"
          [step]="0.01"
          (input)="onDirectDiscountChange($event)"
          [readonly]="readOnly()"
        />
        @if (directDiscount() > 0) {
          <span class="price-info">- {{ directDiscount() | currency:'EUR':'symbol':'1.2-2' }}</span>
        }
      </div>

      <div class="note-input">
        <label>Note :</label>
        <textarea 
          [value]="note()"
          (input)="onNoteChange($event)"
          placeholder="Ajouter une note (optionnel)"
          rows="2"
          [readonly]="readOnly()"
        ></textarea>
      </div>
    </div>

    <!-- Total -->
    <div class="total-section">
      <h3>Récapitulatif</h3>
      <div class="total-details">
        <p><strong>Tables réservées :</strong> {{ totalTables() }} ({{ totalM2() | number:'1.1-1' }} m²)</p>
        <p><strong>Prises :</strong> {{ nbPrises() }}</p>
        <p><strong>Prix de base :</strong> {{ startPrice() | currency:'EUR':'symbol':'1.2-2' }}</p>
        @if (tableDiscountOffered() > 0 || directDiscount() > 0) {
          <p class="discount-line">
            <strong>Remises :</strong> 
            - {{ (tableDiscountAmount() + directDiscount()) | currency:'EUR':'symbol':'1.2-2' }}
            @if (tableDiscountOffered() > 0) {
              <span class="discount-detail">({{ tableDiscountOffered() }} table(s) offerte(s))</span>
            }
          </p>
        }
        <p class="total-price">
          <strong>Prix final :</strong> 
          <span class="price">{{ finalPrice() | currency:'EUR':'symbol':'1.2-2' }}</span>
        </p>
      </div>
    </div>

    <!-- Message et bouton de sauvegarde -->
    @if (message()) {
      <p class="message" [class.success]="!isError()" [class.error]="isError()">
        {{ message() }}
      </p>
    }
    
    @if (!readOnly()) {
      <div class="actions">
        <button 
          class="save-btn" 
          (click)="saveReservation()" 
          [disabled]="saving()">
          {{ saving() ? 'Sauvegarde...' : 'Sauvegarder' }}
        </button>
      </div>
    }
  } @else {
    <p class="no-data">Aucune réservation trouvée.</p>
  }
</div>
