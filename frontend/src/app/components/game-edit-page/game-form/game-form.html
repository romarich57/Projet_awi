<section class="card form-card">
  @if (loading()) {
    <p class="muted">Chargement du jeu...</p>
  }
  @if (error()) {
    <p class="error">{{ error() }}</p>
  }

  <form class="grid" (ngSubmit)="submit()">
    <div class="full preview">
      <div class="game-avatar" [class.fallback]="!safeImagePreview()">
        @if (safeImagePreview()) {
          <img [src]="safeImagePreview()" [alt]="localFormData().title" loading="lazy" />
        } @else {
          <span>{{ localFormData().title.charAt(0) || '?' }}</span>
        }
      </div>
      <div class="muted">Aperçu de l'image (image_url)</div>
    </div>
    <label>
      <span>Titre *</span>
      <input
        type="text"
        name="title"
        [ngModel]="localFormData().title"
        (ngModelChange)="updateForm({ title: $event })"
        required />
    </label>
    <label>
      <span>Type *</span>
      <input
        type="text"
        name="type"
        [ngModel]="localFormData().type"
        (ngModelChange)="updateForm({ type: $event })"
        required />
    </label>
    <label>
      <span>Éditeur *</span>
      <select
        name="editor"
        [ngModel]="localFormData().editor_id"
        (ngModelChange)="updateForm({ editor_id: $event })"
        required>
        <option value="" disabled>Choisir un éditeur</option>
        @for (editor of editors(); track editor.id) {
          <option [value]="editor.id">{{ editor.name }}</option>
        }
      </select>
    </label>
    <label>
      <span>Âge minimum *</span>
      <input
        type="number"
        name="age"
        min="0"
        [ngModel]="localFormData().min_age"
        (ngModelChange)="updateForm({ min_age: $event })"
        required />
    </label>
    <label>
      <span>Joueurs min</span>
      <input
        type="number"
        name="min_players"
        min="1"
        [ngModel]="localFormData().min_players"
        (ngModelChange)="updateForm({ min_players: $event })" />
    </label>
    <label>
      <span>Joueurs max</span>
      <input
        type="number"
        name="max_players"
        min="1"
        [ngModel]="localFormData().max_players"
        (ngModelChange)="updateForm({ max_players: $event })" />
    </label>
    <label>
      <span>Auteurs *</span>
      <input
        type="text"
        name="authors"
        [ngModel]="localFormData().authors"
        (ngModelChange)="updateForm({ authors: $event })"
        required />
    </label>
    <label class="checkbox">
      <input
        type="checkbox"
        name="prototype"
        [ngModel]="localFormData().prototype"
        (ngModelChange)="updateForm({ prototype: $event })" />
      <span>Prototype</span>
    </label>
    <label>
      <span>Durée (minutes)</span>
      <input
        type="number"
        name="duration"
        min="0"
        [ngModel]="localFormData().duration_minutes"
        (ngModelChange)="updateForm({ duration_minutes: $event })" />
    </label>
    <label>
      <span>Thème</span>
      <input
        type="text"
        name="theme"
        [ngModel]="localFormData().theme"
        (ngModelChange)="updateForm({ theme: $event })" />
    </label>
    <label>
      <span>Description</span>
      <textarea
        name="description"
        rows="3"
        [ngModel]="localFormData().description"
        (ngModelChange)="updateForm({ description: $event })"></textarea>
    </label>
    <div class="full image-source">
      <span>Source de l'image</span>
      <div class="source-toggle">
        <button
          type="button"
          class="chip"
          [class.active]="imageSource() === 'url'"
          (click)="imageSourceChanged.emit('url')">
          URL
        </button>
        <button
          type="button"
          class="chip"
          [class.active]="imageSource() === 'file'"
          (click)="imageSourceChanged.emit('file')">
          Fichier
        </button>
      </div>
    </div>
    @if (imageSource() === 'url') {
      <label>
        <span>Image (URL)</span>
        <input
          type="url"
          name="image_url"
          [ngModel]="localFormData().image_url"
          (ngModelChange)="updateForm({ image_url: $event })" />
      </label>
    } @else {
      <label>
        <span>Importer une image</span>
        <input type="file" accept="image/*" (change)="onFileSelected($event)" />
      </label>
      @if (isUploadingImage()) {
        <p class="muted full">Upload en cours...</p>
      }
      @if (imageUploadError()) {
        <p class="error full">{{ imageUploadError() }}</p>
      }
    }
    <label>
      <span>Vidéo des règles (URL)</span>
      <input
        type="url"
        name="rules_video_url"
        [ngModel]="localFormData().rules_video_url"
        (ngModelChange)="updateForm({ rules_video_url: $event })" />
    </label>
    <label class="full">
      <span>Mécanismes</span>
      <app-game-mechanisms-select
        [mechanisms]="mechanisms()"
        [selectedIds]="localFormData().mechanismIds"
        (selectedIdsChange)="updateForm({ mechanismIds: $event })" />
    </label>

    <div class="actions full">
      <button type="submit" class="primary strong" [disabled]="saving()">
        Enregistrer les modifications
      </button>
      <a class="ghost" href="/games" (click)="onCancel($event)">Annuler</a>
    </div>
  </form>
</section>
